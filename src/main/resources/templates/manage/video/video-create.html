<!DOCTYPE html>
<html lang="en" xmlns:th="www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Đăng bài viết mới</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"
	rel="stylesheet">
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
	rel="stylesheet">
<style>
body {
	background-color: #111;
	color: white;
	font-family: 'Segoe UI', sans-serif;
	padding: 40px 0;
}

.container {
	max-width: 800px;
}

.form-label {
	font-weight: bold;
}

.btn-submit {
	background-color: orange;
	border: none;
}

.btn-submit:hover {
	background-color: darkorange;
}

#editor {
	height: 300px;
	background: #fff;
	color: #000;
}
/* tag styles */
.tag-badge {
	background: dodgerblue;
	color: #fff;
	border-radius: 20px;
	padding: 4px 10px;
	margin: 2px;
	display: inline-flex;
	align-items: center;
}

.tag-badge i {
	cursor: pointer;
	margin-left: 6px;
}
</style>
</head>
<body>
	<div class="container">
		<h1 class="text-center mb-5">Tạo/Cập nhật Video!</h1>
		<form id="postForm" th:method="post" th:action="@{/admin/video}"
			enctype="multipart/form-data" th:object="${creator}">

			<div class="mb-3" th:if="*{id != null}" style="text-align: center;">
				<span th:text="'Cập nhật: ' + *{id}"></span> <input type="hidden"
					th:field="*{id}">
			</div>
			<div class="mb-3" th:unless="*{id != null}">
				<label for="title" class="form-label">Tiêu đề Video</label> <input
					type="text" class="form-control" id="title" th:field="*{id}"
					placeholder="Nhập tiêu đề..." required>
				<p class="text-danger" id="tittle-warning"
					style="display: none; font-weight: bold;">Tiêu đề chỉ được chứa
					chữ cái và số!</p>
			</div>

			<!-- Categories input -->
			<div class="mb-3">
				<input type="hidden" th:field="*{categories}" id="categories">
				<label class="form-label">Thể loại</label>
				<div class="input-group mb-2">
					<input type="text" id="categoriesInput" class="form-control"
						placeholder="Nhập thể loại và nhấn Enter">
				</div>
				<div id="categoriesList"></div>
			</div>

			<div class="mb-3">
				<label for="director" class="form-label">Đạo diễn</label> <input
					type="text" class="form-control" id="director"
					th:field="*{director}"
					th:value="*{director != null ? director : ''}"
					placeholder="Tên đạo diễn..." required>
			</div>

			<!-- Country input -->
			<div class="mb-3">
				<label for="director" class="form-label">Quốc gia</label> <input
					type="text" class="form-control" th:field="*{country}" id="country"
					th:value="*{country != null ? country : ''}"
					placeholder="Quốc gia..." required>
			</div>

			<div class="mb-3">
				<label for="studio" class="form-label">Studio</label> <input
					type="text" class="form-control" id="studio" th:field="*{studio}"
					th:value="*{studio != null ? studio : ''}" placeholder="Studio..."
					required>
			</div>

			<div class="mb-3">
				<label for="language" class="form-label">Ngôn ngữ</label> <input
					type="text" class="form-control" id="language"
					th:field="*{language}"
					th:value="*{language != null ? language : ''}"
					placeholder="Ngôn ngữ..." required>
			</div>

			<div class="mb-3">
				<label class="form-label">Nội dung bài viết</label>
				<div id="toolbar" class="mb-2">
					<span class="ql-formats"> <select class="ql-header"></select>
						<button class="ql-bold"></button>
						<button class="ql-italic"></button>
						<button class="ql-underline"></button>
					</span> <span class="ql-formats">
						<button class="ql-list" value="ordered"></button>
						<button class="ql-list" value="bullet"></button>
						<button class="ql-link"></button>
						<button class="ql-image"></button>
					</span>
				</div>
				<div id="editor"></div>
				<textarea style="display: none;" th:field="*{description}"
					id="description"></textarea>
			</div>
		</form>
		<div class="mb-3">
			<label for="banner" class="form-label">Chọn ảnh banner</label> <input
				type="file" class="form-control" id="avatar" accept="image/*"
				required>
			<div style="text-align: center; margin-top: 10px;">
				<img width="100" id="img-preview">
			</div>
		</div>

		<div class="mb-3">
			<label for="video" class="form-label">Chọn ảnh video</label> <input
				type="file" class="form-control" id="video" accept="video/*"
				required>
			<div style="text-align: center; margin-top: 10px;">
				<video width="300" id="video-preview" controls="controls"></video>
			</div>
		</div>

		<div class="text-center">
			<button type="button" class="btn btn-submit px-4 py-2 text-white"
				onclick="submit()">Đăng Video</button>
		</div>

	</div>
	<!-- Quill JS -->
	<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
	<script type="text/javascript" src="/js/create-update.js"></script>
	<script th:inline="javascript">
  const categoriesInput = document.getElementById('categoriesInput'); //The input for category
  const categoriesList = document.getElementById('categoriesList');
  let content = /*[[${creator.description}]]*/ ''
  let currentVideo
	  let currentImage
	let urlAction = "/admin/video"
  var categories = /*[[${creator.categories}]]*/ null //Checking if there is any data before
	  if(categories === null)
		  categories = []
	window.addEventListener("DOMContentLoaded",  async () => {
		if(content != null && content != '')
			await quill.clipboard.dangerouslyPasteHTML(content)
		if(categories.length > 0)
		{	
			let temp = categories.split(",")
			checking(categories, categoriesList)
			categories = temp
		}
		setup()
		getOldVideo()
		getOldImage()
		addEventVideo()
		addEventImage()
	})
	//Setup event for tag and url of form action when load page
  function setup() 
  {
	  const creatorId = /*[[${creator.id}]]*/ ''
		  if(creatorId !== null) //if there is creator's id the action will be change to update
			{
			  urlAction = "/admin/video/update"
			}
	  addEventTag(categoriesInput, categories, categoriesList, "categories")
  }

//remove tag
  categoriesList.addEventListener('click', e=>{
	    if(e.target.matches('i')){
	      const idx = e.target.dataset.idx;
	      categories.splice(idx,1);
	      let categoriesInput = document.getElementById("categories")
	      categoriesInput.value = categories
	      renderTags(categories, categoriesList);
	    }
	  });
  

  function checkingData() //Checking categories when submit
  {
	  let categories = document.getElementById("categories")
		  if(categories.value == '')
			  {
				  alert("Bạn cần nhập dữ liệu cho 'Thể loại'")
				  return false
			  }
	  return true
  }

	function getOldVideo()
	{
		let videoSrc = /*[[${creator.pathVideo}]]*/ ''
		if(videoSrc !== '')
		{
			fetch("/video/"+videoSrc).then(data => data.blob()).then(blob =>{ //Access to server and data then transfer the data to blob type
				currentVideo = new File([blob], videoSrc, {type: blob.type})
				previewVideoHandling(currentVideo)
			})
		}
	}
	function getOldImage()
	{
		let avatarSrc = /*[[${creator.pathAvatar}]]*/ ''
		if(avatarSrc !== '')
		{
			fetch("/img/video-avatar/"+avatarSrc).then(data => data.blob()).then(blob =>{
				currentImage = new File([blob], avatarSrc, {type: blob.type})
				previewImageHandling(currentImage);
			})
		}
		
	}

	function previewImageHandling(currentImage)
	{
		let url = URL.createObjectURL(currentImage)
		let imgPreview = document.getElementById("img-preview")
		imgPreview.src=url
	}

	function previewVideoHandling(currentVideo)
	{
		let url = URL.createObjectURL(currentVideo)
		let videoPreview = document.getElementById("video-preview");
		videoPreview.src = url
		videoPreview.load()
	}
	
	//submit form with chosen video and avatar
  function submit()
  {
	  if(checkingData())
		  {
		  setContent()
		  let form = document.getElementById("postForm")
		  let formData = new FormData(form)  
		  formData.append("video", currentVideo, currentVideo.name)
			formData.append("avatar", currentImage, currentImage.name);
		  fetch(urlAction, {
				method: "POST",
				body: formData
			  }).then(res =>{
				  window.location.replace("/admin/video");
			  })
	}
  }
	function addEventVideo()
	{
		let videoInput = document.getElementById("video")
		videoInput.addEventListener("change", function (){
			const file = this.files[0] //Get the file user inputed
			if(file)
			{
				currentVideo = file
				previewVideoHandling(currentVideo)
			}
				
		})
	}

	function addEventImage()
	{
		let imageInput = document.getElementById("avatar")
		imageInput.addEventListener("change", function (){
			const file = this.files[0]
			if(file)
			{
				currentImage = file
				previewImageHandling(currentImage)
			}
				
		})
	}
  
//=======
async function checking(values, list)
  	{
				var splitted = await values.split(",")
				values = []
				for(let i = 0; i < splitted.length; i++)
				{
					if(splitted[i].trim() != '')
						addTag(splitted[i], values, list)
				}
	}

  function addEventTag(input, values, list, id) //Handling event when inputed  
  {
	  // Add tag on Enter
	  input.addEventListener('keydown', e => {
	    if(e.key === 'Enter'){
	      e.preventDefault();
	      const val = input.value.trim();
	      values = addTag(val, values, list)
	      input.value='';
	      let tag = document.getElementById(id)
		  tag.value = values
	    }
	  });
  }
 
  function addTag(val, values, list)
  {
	  
	  if(val && !values.includes(val)){
		  values.push(val);
	      renderTags(values, list);
	      return values
	  }
  }
  
  function renderTags(values, list){
	  list.innerHTML='';
	  values.forEach((tag, idx)=>{
      const span = document.createElement('span');
      span.className='tag-badge';
      span.innerHTML = `${tag} <i class="fas fa-times" data-idx="${idx}"></i>`;
      list.appendChild(span);
    });
  }

</script>
</body>
</html>